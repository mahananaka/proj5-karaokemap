<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>Leaflet and Mapbox Map</title>

  <!-- 'viewport' is used by bootstrap to respond to device size -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Javascript:  JQuery from a content distribution network (CDN) -->
  <script
     src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
  </script>

  <!-- Bootstrap includes javascript and css  (must follow jquery) -->
  <link rel="stylesheet"
   href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
   <script
    src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js">
   </script>

  <!-- Must haves for Mapbox -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />

  <!-- Must haves for Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
  
</head>

   <!-- Our own style sheet -->
   <link rel="stylesheet" href="{{ url_for('static',filename='map.css') }}" />

<body>
<!-- bootstrap requires a 'container' div around content -->
<div class="container">


<h1 class="text-center">Leaflet and Mapbox Map</h1>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class=flashes>
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
<br>

<div id="mapid"></div>


<script type="text/javascript">
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
  
  var mymap = L.map('mapid').setView([44.059, -123.101], 13 );
  var popup = L.popup();
 
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ session.mapboxtoken }}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: '{{ session.mapboxid }}',
      accessToken: '{{ session.mapboxtoken }}'
  }).addTo(mymap);

  function onMapClick(e) {

    console.log(e.originalEvent);

    if(e.originalEvent.shiftKey)
      console.log("yep");
    else
      console.log("nope");

    popup.setLatLng(e.latlng);
        popup.setContent("You clicked the map at " + e.latlng.toString());
        popup.openOn(mymap);

    //var marker = L.marker(e.latlng).addTo(mymap);
    //marker.bindPopup("<b>Hello User!</b><br>Is this your location?").openPopup();
  }

  mymap.on('click', onMapClick);

  $(document).ready(function(){
      $.post( "/_get_pins", { }, //function to call on server, no arguments
        function(data) { //this function handles the response.
          for (var i=0; i<data.result.length; i++) {
            poi = data.result[i];
            
            reverseGeocoding(poi["lat"],poi["long"],poi["description"])
          }
        }
      );
  });   // end of what we do on document ready

  var reverseGeocoding = function(lat,long, desc){
    var geocoding_url = "https://api.mapbox.com/geocoding/v5/mapbox.places/" 
            + String(long) + "%2C%20" + String(lat) + ".json?access_token={{ session.mapboxtoken }}&types=address";

    $.getJSON(geocoding_url,
      // response handler
      function(data) {
        var pop_string = "<b>" + desc + "</b>"

        if(data.features.length>0){
          var parts = data.features[0].place_name.split(",")
          pop_string = "<br>" + parts[0] + "<br>" + parts[1] + "," + parts[2];
        }

        var marker = L.marker([lat,long]).addTo(mymap);
        marker.bindPopup(pop_string);
      
    }); // End of getJSON
  }

//"https://api.mapbox.com/geocoding/v5/mapbox.places/" + e.latlng + ".json?access_token={{ session.access_token}}"

</script>

</div>
</body> </html>
